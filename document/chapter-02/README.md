# 리팩터링 원칙 

Chapter 1 에서 리팩토링이 무엇인지 충분히 감 잡았을 것이다. 

이를 토대로 이번 장에서는 잠시 시야를 넓혀 리팩터링 전반에 적용되는 원칙 몇 가지를 이야기하는 시간을 갖자. 

***

## 2.1 리팩터링 정의 

수많은 다른 소프트웨어 개발 용어와 마찬가지로 리팩토링(Refactoring) 도 엔지니어들 사이에서 다소 두리뭉실한 의미로 통용된다. 

하지만 나는 이 용어를 더 구체적인 의미로 사용해야 더 유용하다고 생각한다. 

리팩토링이란 용어는 명사로도 사용할 수 있고 동사로도 사용하는게 가능하다. 

먼저 명사의 뜻은 다음과 같다. 

__리팩토링: [명사] 소프트웨어의 겉보기 동작을 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 바꾸는 것__

앞 장에서 사용한 함수 추출하기와 조건부 로직을 다형성으로 바꾸기가 이 기법에 적용된다. 

동사 버전의 리팩토링의 뜻은 다음과 같다. 

__리팩토링(하다): [동사] 소프트웨어의 겉보기 동작을 그대로 유지한 채, 여러가지 리팩토링 기법을 적용해서 소프트웨어를 재구성한다.__

여기서는 리팩토링 기법이라는 말에 주목하자. 

리팩토링은 여러 작은 단계로 나눠서 실행한다. (컴파일-테스트-커밋) 이를 통해 소프트웨어의 동작을 유지할 수 있다는 뜻이다. 

__누군가 "리팩토링하다가 코드가 깨져서 며칠이나 고생했다." 라고 한다면 그는 리팩토링을 한 것이 아니다.__

그리고 리팩토링 기법도 체계적으로 여러가지가 있다. __(뭐 변수를 인라인 함수로 만들기, 문장 이동시키기, 함수 추출하기, 함수 옮기기, 단계 나누기 등)__

나는 단순히 코드 베이스를 정리하거나 구조를 바꾸는 모든 작업은 재구성(Restructuring) 이라고 한다. __(코드를 다듬는 용으로는 Polish 라는 용어를 사용하기도 한다.)__

리팩토링은 성능 최적화와 비슷하다. 

둘 다 코드를 변경하지만 프로그램의 기능은 정상적으로 작동한다. 

단지 목적만 다를 뿐이다. 

리팩토링은 코드를 이해하고 수정하기 쉽게 바꾸는 것이라면 

성능 최적화는 오로지 속도에만 싱경쓴다. 

그래서 목표 성능에 반드시 도달해야 한다면 코드의 이해는 더 어려워질 수 있다. 

***

## 2.2 두 개의 모자 

나는 소프트웨어를 개발할 때 목적을 두 개로 나눈다. 

'기능 추가' 와 '리팩토링' 을 명확히 구별한다. 

켄트 백은 이를 두 개의 모자에 비유했다. 

기능을 추가할 때는 '기능 추가' 모자를 쓴 다음 기존 코드는 절대 건드리지 않고 새 코드를 쓰는 것에만 집중한다. 

진척도는 테스트를 통과하느냐를 확인하는 방법으로 측정한다. __(TDD 를 말하는 것인듯.)__

반면 리팩토링할 때는 '리팩토링 모자' 를 쓴 다음 기능 추가는 절대 하지 않기로 다짐하고 오로지 코드 재구성에만 신경쓴다.

이는 앞 과정에서 놓친 테스트 케이스를 발견하지 않는다면 절대 테스트도 추가하지 않는다. 

부득이 인터페이스를 변경할 때만 기존 테스트를 수정한다. __(인터페이스를 바꾸는 건 기능 추가의 종류 중 하나라고 생각한다.)__

소프트웨어를 개발하는 동안 나는 두 모자를 자주 바꿔 쓴다. 

새 기능을 추가하다 보면 코드 구조를 바꿔야 작업하기 훨씬 수월하겠다는 생각이 드는데 그러면  잠시 '기능 추가 모자' 에서 '리팩토링 모자' 로 바꿔쓴다. 

그 다음에 리팩토링이 다 끝나면 기존의 기능 추가 모자를 다시 쓴다. 

정리하면 소프트웨어를 개발할때 내가 어떤 모자를 쓰고 있는지 늘 점검하면서 개발하자. 

***

## 2.3 리팩토링하는 이유 

리팩토링의 목적은 모든 문제점을 해결하는 것이 아니다. 

오로지 코드를 이해하기 쉽고 수정하기 쉽도록 바꾸는 것이다. 

리팩토링은 다양한 용도로 활용하는게 가능한데 이를 살펴보자.

### 리팩토링하면 소프트웨어 설계가 좋아진다. 

리팩토링 하지 않으면 소프트웨어의 내부 설계(아키텍처) 가 썩기 쉽다. 

아키텍처를 충분히 이해하지 못한 채 단기 목표만을 위해 코드를 수정하다 보면 기반 구조가 무너지기 쉽다. __(DIP 에 의지해야 한다는 점.)__

코드만 봐서는 설계를 파악하기 어려워지고 코드 구조가 무너지기 시작하면 악효과가 누적된다. 

코드만으로 설계를 파악하기 어려워질수록 설계를 유지하기 어려워지고, 설계가 부패된다. __(확장을 할 수 없는 단계를 말하는 것이라고 생각한다.)__

같은 일을 하더라도 설계가 나쁘면 코드가 길어진다.

사실상 같은 일을 하는 코드가 여러곳에 나타나게 된다. __(코드 중복을 야기한다.)__

__중복 코드가 낳는 문제는 수정하는 비용과 이해하는 비용이 크게 증가한다는 점이다.__

### 리팩토링하면 소프트웨어를 이해하기 쉬워진다. 

프로그래밍은 여러 면에서 컴퓨터와 대화하는 것과 같다. 

컴퓨터에게 시킬 일을 표현하는 코드를 작성하면 컴퓨터는 정확히 시킨대로 반응한다. 

그래서 컴퓨터에게 시킬 일과 이를 표현하는 코드의 차이를 최대한 줄여야 한다. 

그러므로 프로그래밍은 내가 원하는 바를 정확히 표현하는 것이다. 

그치만 코드는 컴퓨터만 읽는게 아니다. 

나와 같이 일하는 또는 개발자도 코드를 읽는다. 

코드를 이해하기 쉽게 쓰지 않았더라면 이는 다른 개발자를 배려하지 못한 것이다.

리팩토링은 코드가 더 잘 읽히게 도와준다. 

잘 작동하지만 이상적인 구조가 아닌 코드가 있다면 잠깐 시간을 내서 리팩토링 하는걸 추천한다. 

코드의 목적이 더 잘 드러나게 의도가 더 잘 표현되게 개선하자. 

리팩토링은 다른 사람들 뿐 아니라 나 자신을 위해서라도 해야한다. 

내가 작성한 코드들을 다 외우지 않는다. 언제든지 잊어버릴 수 있다. 실제로 그렇기도 하고. 

### 리팩토링하면 버그를 쉽게 찾을 수 있다. 

코드를 이해하기 십다는 말은 버그를 찾기 쉽다는 말과도 같다. 

리팩토링 하면 코드가 하는 일이 명확해지므로 이는 버그를 발견하는데 도움을 준다. 

리팩토링을 통해 프로그램의 구조를 명확하게 다듬으면 '그냥 이럴 것이다' 라고 가정하던 부분들이 명확히 드러나는데 이를 통해 버그를 쉽게 찾을 수 있다. 

이 사실은 켄트 백의 말을 떠올리게 해준다. __"난 뛰어난 프로그래머가 아니에요. 단지 뛰어난 습관을 지닌 괜찮은 프로그래머일 뿐이에요."__ 

리팩토링은 견고한 코드를 작성하는 데 무척 효과적이다. 

### 리팩토링하면 프로그래밍 속도를 높일 수 있다. 

지금까지 제시한 장점을 추상화하면 다음과 같다. 

__리팩토링하면 코드 개발 속도를 높일 수 있다.__

얼핏 그 반대가 아닌가 생각할 수도 있다.

리팩토링이 내부 설계와 코드 퀄리티를 높일 수 있다는 점은 대부분 순응한다. 

하지만 리팩토링하는 데 시간이 드니 전체 개발 속도가 떨어질까봐 걱정할 수도 있다. 

__한 시스템을 오래 개발하는 개발자들과 얘기하다 보면 초기에는 진척이 빨랐지만 현재는 새 기능을 하나 추가하는데 훨씬 오래 걸린다는 말을 많이 한다.__

새로운 기능을 추가할수록 기존 코드베이스에 잘 녹여낼 방법을 찾는 데 드는 시간이 늘어난다는 것이다.

게다가 기능을 추가하다보면 버그가 발생하는 일이 잦고, 이를 해결하는 시간은 한층 더 걸린다. 

코드베이스는 패치에 패치가 덧붙여지면서 프로그램의 동작을 파악하기가 더욱 어려워진다. 

이러한 부담이 점점 늘어나다보면 차라리 처음부터 새로 개발하는 편이 낫겠다고 생각하는 지경에 다다른다. 

하지만 좋은 설계를 지닌 팀은 기존에 작성한 코드를 최대한 활요할 수 있어서 새 기능을 더 빨리 추가하는게 가능해진다. 

이렇게 차이 나는 원인은 소프트웨어의 내부 품질에 있다. 

내부 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 때 모듈화가 잘되어있어서 코드의 작성 포인트를 쉽게 찾을 수 있다.

코드가 명확하면 버그를 만들 가능성도 줄고, 버그를 만들더라도 디버깅하기가 훨씬 쉽다. 

내부 품질이 뛰어난 코드베이스는 새 기능 구축을 돕는다. 

나는 이 효과를 설계 지구력 가설 (Design Stamina Hypothesis) 라고 부른다.

__내부 설계에 심혈을 기울이면 소프틍뤠어의 지구력이 높아져서 빠르게 개발할 수 있는 상태를 더 오래 지속할 수 있다.__

***

## 2.4 언제 리팩터링해야 할까? 

나는 프로그래밍할 때 거의 한 시간 간격으로 리팩토링한다. 

그러다 보니 내 작업 흐름에 리팩토링을 녹이는 방버이 여러 가지임을 알게 됐다. 

### 3의 법칙 

> 이건 돈 로버츠 (Don Roberts) 가 내게 제시한 가이드다. 
>
> 1. 처음에는 그냥 한다.
> 2. 비슷한 일을 두 번째로 하게 되면 (중복이 생겼다면) 일단 계속 진행한다. 
> 3. 비슷한 일을 세 번째 하게 되면 리팩토링 한다. 
>
> 야구를 좋아하는 사람은 "스트라이크 세 번이면 리팩토링하라" 하고 기억해도 좋다. 

### 준비를 위한 리팩토링: 기능을 쉽게 추가하게 만들기
 
리팩토링하기 가장 좋은 시점은 코드베이스에 기능을새로 추가하기 직전이다. 

이 시점에서 현재 코드를 살펴보면서, 구조를 살짝 바꾸면 다른 작업을 하기가 훨씬 쉬워질 만한 부분을 찾는다. 

가령 내 요구사항을 모두 맍고하지만 리터럴 값 몇 개가 방해되는 함수가 있을 수 있다. 

함수를 복제해서 해당 값만 수정해도 되지만, 그러면 중복 코드가 생긴다. 

나중에 이 기능을 바꾼다면 수정 포인트가 여러개가 되므로 리팩토링한다.


  
 


